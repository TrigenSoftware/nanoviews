import {
  type AnyObject,
  toAccessor
} from 'kida'

type PropsProxyHandler = ProxyHandler<Record<string, unknown>> & { k?: string[] }

const handler: PropsProxyHandler = {
  k: undefined,
  get(target, key: string) {
    if (key[0] === '$') {
      this.k!.push(key = key.slice(1))

      return toAccessor(target[key])
    }

    return target[key]
  },
  ownKeys() {
    return this.k!
  }
}

export type Props$<T> = T & {
  [K in keyof T as `$${string & K}`]: NonEmptyValue<T[K]> extends AnyFn
    ? T[K]
    : ToSignal<T[K]>
}

export function props$(props) {
  const propsHandler = Object.create(handler) as PropsProxyHandler

  propsHandler.k = Reflect.ownKeys(props) as string[]

  return new Proxy(props, propsHandler)
}
